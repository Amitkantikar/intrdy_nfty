name: Nifty Level Detector

on:
  workflow_dispatch:   # Manual Run Only

jobs:
  run-script:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install yfinance pandas numpy statsmodels scikit-learn requests

      - name: Run Nifty Scanner
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          python << 'EOF'
import os, requests, subprocess
from datetime import datetime, timedelta

def last_market_day():
    today = datetime.now().date()
    wd = today.weekday()  # Monday=0 ... Sunday=6
    if wd == 0:  # Monday â†’ use Friday
        return today - timedelta(days=3)
    elif wd == 6:  # Sunday
        return today - timedelta(days=2)
    elif wd == 5:  # Saturday
        return today - timedelta(days=1)
    else:
        return today - timedelta(days=1)

target = last_market_day()
target_str = target.strftime("%d-%m-%Y")
print("Using market day:", target_str)

p = subprocess.Popen(
    ["python", "intrdy_nif_scanner.py"],
    stdin=subprocess.PIPE,
    text=True
)
p.communicate(input=target_str)

BOT_TOKEN = os.getenv("BOT_TOKEN")
CHAT_ID = os.getenv("CHAT_ID")
msg = f"Nifty levels generated for {target_str}"

requests.post(
    f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage",
    data={"chat_id": CHAT_ID, "text": msg}
)
EOF
